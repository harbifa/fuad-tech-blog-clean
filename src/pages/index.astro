---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Hero from '../components/Hero.astro';
import CategorySection from '../components/CategorySection.astro';
import BlogCard from '../components/BlogCard.astro';
import Footer from '../components/Footer.astro';
import BrevoNewsletterForm from '../components/BrevoNewsletterForm.astro';

// Get all posts and sort by date
const allPosts = await getCollection('posts');
const sortedPosts = allPosts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Get featured posts
const featuredPosts = sortedPosts
  .filter(post => post.data.featured)
  .slice(0, 3)
  .map(post => ({
    title: post.data.title,
    excerpt: post.data.description,
    category: post.data.category,
    date: post.data.date.toLocaleDateString('ar-SA', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    }),
    readTime: post.data.readTime,
    image: post.data.image,
    slug: post.slug,
    tags: post.data.tags,
    featured: post.data.featured,
    affiliate: post.data.affiliate
  }));

// Get recent posts (excluding featured ones)
const recentPosts = sortedPosts
  .filter(post => !post.data.featured)
  .slice(0, 3)
  .map(post => ({
    title: post.data.title,
    excerpt: post.data.description,
    category: post.data.category,
    date: post.data.date.toLocaleDateString('ar-SA', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    }),
    readTime: post.data.readTime,
    image: post.data.image,
    slug: post.slug,
    tags: post.data.tags,
    featured: post.data.featured,
    affiliate: post.data.affiliate
  }));
---

<Layout title="مدونة عزيز - متخصصة في الشبكات والأمن السيبراني والتسويق الرقمي">
  <Header />
  <Hero />
  <CategorySection />
  
  <!-- Featured Posts -->
  {featuredPosts.length > 0 && (
    <section id="latest-posts" class="py-16">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <h2 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">
            المقالات المميزة
          </h2>
          <p class="text-xl text-gray-600 dark:text-gray-300">
            اكتشف أحدث المقالات والدروس المتخصصة
          </p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
          {featuredPosts.map(post => (
            <BlogCard {...post} />
          ))}
        </div>
      </div>
    </section>
  )}
  
  <!-- Recent Posts -->
  {recentPosts.length > 0 && (
    <section class="py-16 bg-gray-50 dark:bg-gray-800">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <h2 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">
            أحدث المقالات
          </h2>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {recentPosts.map(post => (
            <BlogCard {...post} />
          ))}
        </div>
        
        <div class="text-center mt-12">
          <a 
            href="/posts" 
            class="inline-flex items-center px-8 py-3 bg-primary-600 hover:bg-primary-700 text-white font-semibold rounded-lg transition-colors"
          >
            عرض جميع المقالات
            <i class="fas fa-arrow-left ml-2"></i>
          </a>
        </div>
      </div>
    </section>
  )}
  
  <!-- Newsletter -->
  <section class="py-16">
    <div class="container mx-auto px-4">
      <BrevoNewsletterForm 
        variant="compact"
        source="homepage"
        title="اشترك في النشرة البريدية"
        description="احصل على أحدث المقالات والدروس مباشرة في بريدك الإلكتروني"
      />
    </div>
  </section>
  
  <Footer />
</Layout>

<style>
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<!-- Newsletter now uses Brevo integration -->