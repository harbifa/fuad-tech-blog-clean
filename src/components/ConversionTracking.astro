---
// ØªØªØ¨Ø¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø£Ù‡Ø¯Ø§Ù
---

<script>
  // Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª
  document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ¯ Conversion Tracking: Initializing...');
    
    // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù
    const conversionGoals = {
      newsletter_signup: {
        name: 'Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù†Ø´Ø±Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠØ©',
        value: 5,
        currency: 'SAR'
      },
      affiliate_click: {
        name: 'Ù†Ù‚Ø±Ø© Ø±Ø§Ø¨Ø· ØªØ§Ø¨Ø¹',
        value: 2,
        currency: 'SAR'
      },
      article_complete: {
        name: 'Ø¥ÙƒÙ…Ø§Ù„ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù‚Ø§Ù„',
        value: 1,
        currency: 'SAR'
      },
      search_performed: {
        name: 'Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹',
        value: 0.5,
        currency: 'SAR'
      },
      social_share: {
        name: 'Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©',
        value: 1.5,
        currency: 'SAR'
      },
      pwa_install: {
        name: 'ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚',
        value: 10,
        currency: 'SAR'
      }
    };
    
    // ØªØªØ¨Ø¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„
    function trackConversion(goalType, additionalData = {}) {
      const goal = conversionGoals[goalType];
      if (!goal) return;
      
      gtag('event', 'conversion', {
        send_to: 'AW-CONVERSION_ID/CONVERSION_LABEL', // Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ù…Ø¹Ø±Ù Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ
        value: goal.value,
        currency: goal.currency,
        event_category: 'conversion',
        event_label: goal.name,
        ...additionalData
      });
      
      // ØªØªØ¨Ø¹ Ù…Ø®ØµØµ Ù„Ù„ØªØ­ÙˆÙŠÙ„
      gtag('event', goalType, {
        event_category: 'goal_completion',
        event_label: goal.name,
        value: goal.value,
        ...additionalData
      });
      
      console.log('ğŸ¯ Conversion tracked:', goalType, goal);
    }
    
    // ØªØªØ¨Ø¹ Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù†Ø´Ø±Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠØ©
    const newsletterForms = document.querySelectorAll('#newsletter-form, [data-newsletter-form]');
    newsletterForms.forEach(form => {
      form.addEventListener('submit', function(e) {
        trackConversion('newsletter_signup', {
          form_location: this.dataset.location || 'unknown'
        });
      });
    });
    
    // ØªØªØ¨Ø¹ Ø§Ù„Ù†Ù‚Ø±Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ§Ø¨Ø¹Ø©
    document.addEventListener('click', function(e) {
      const link = e.target.closest('a');
      if (!link) return;
      
      // Ø±ÙˆØ§Ø¨Ø· ØªØ§Ø¨Ø¹Ø©
      if (link.classList.contains('affiliate-link') || 
          link.href.includes('amazon.com') || 
          link.href.includes('affiliate') ||
          link.closest('[data-affiliate]')) {
        
        const productName = link.textContent.trim() || 
                           link.closest('[data-product-name]')?.dataset.productName || 
                           'unknown_product';
        
        trackConversion('affiliate_click', {
          product_name: productName,
          link_url: link.href,
          link_position: getElementPosition(link)
        });
      }
      
      // Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©
      if (link.href.includes('twitter.com/intent') || 
          link.href.includes('linkedin.com/sharing') || 
          link.href.includes('wa.me')) {
        
        const platform = link.href.includes('twitter') ? 'twitter' :
                        link.href.includes('linkedin') ? 'linkedin' :
                        link.href.includes('wa.me') ? 'whatsapp' : 'other';
        
        trackConversion('social_share', {
          platform: platform,
          content_type: 'article',
          content_id: window.location.pathname
        });
      }
    });
    
    // ØªØªØ¨Ø¹ Ø¥ÙƒÙ…Ø§Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù‚Ø§Ù„
    let articleCompleted = false;
    function checkArticleCompletion() {
      if (articleCompleted) return;
      
      const article = document.querySelector('article');
      if (!article) return;
      
      const scrollTop = window.pageYOffset;
      const articleTop = article.offsetTop;
      const articleHeight = article.offsetHeight;
      const windowHeight = window.innerHeight;
      
      const scrolledPastArticle = scrollTop + windowHeight >= articleTop + articleHeight * 0.9;
      const timeOnPage = (Date.now() - window.pageLoadTime) / 1000;
      
      if (scrolledPastArticle && timeOnPage >= 60) {
        articleCompleted = true;
        trackConversion('article_complete', {
          article_title: document.title,
          reading_time: Math.round(timeOnPage),
          article_category: document.querySelector('[data-category]')?.dataset.category || 'unknown'
        });
      }
    }
    
    // ØªØªØ¨Ø¹ Ø§Ù„Ø¨Ø­Ø«
    const searchInputs = document.querySelectorAll('#search-input, [type="search"]');
    searchInputs.forEach(input => {
      let searchTimeout;
      input.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          if (this.value.length >= 3) {
            trackConversion('search_performed', {
              search_term: this.value,
              search_location: this.closest('[data-search-location]')?.dataset.searchLocation || 'header'
            });
          }
        }, 1000);
      });
    });
    
    // ØªØªØ¨Ø¹ ØªØ«Ø¨ÙŠØª PWA
    window.addEventListener('beforeinstallprompt', function() {
      // Ø³ÙŠØªÙ… ØªØªØ¨Ø¹Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª
      const installButtons = document.querySelectorAll('#pwa-install-btn, [data-pwa-install]');
      installButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          trackConversion('pwa_install', {
            install_method: 'prompt',
            user_agent: navigator.userAgent
          });
        });
      });
    });
    
    // ØªØªØ¨Ø¹ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù…ÙŠØ²
    const featuredContent = document.querySelectorAll('[data-featured], .featured');
    featuredContent.forEach(element => {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            gtag('event', 'view_promotion', {
              promotion_id: element.dataset.promotionId || 'featured_content',
              promotion_name: element.dataset.promotionName || 'Featured Content',
              creative_name: element.dataset.creativeName || 'Default',
              creative_slot: getElementPosition(element)
            });
          }
        });
      }, { threshold: 0.5 });
      
      observer.observe(element);
    });
    
    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù†ØµØ±
    function getElementPosition(element) {
      const rect = element.getBoundingClientRect();
      const scrollTop = window.pageYOffset;
      const elementTop = rect.top + scrollTop;
      
      if (elementTop < window.innerHeight) return 'above_fold';
      if (elementTop < window.innerHeight * 2) return 'below_fold';
      return 'deep_scroll';
    }
    
    // ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
    if ('PerformanceObserver' in window) {
      // ØªØªØ¨Ø¹ Core Web Vitals
      const observer = new PerformanceObserver((list) => {
        list.getEntries().forEach((entry) => {
          if (entry.entryType === 'largest-contentful-paint') {
            gtag('event', 'web_vital', {
              event_category: 'performance',
              event_label: 'LCP',
              value: Math.round(entry.startTime)
            });
          }
          
          if (entry.entryType === 'first-input') {
            gtag('event', 'web_vital', {
              event_category: 'performance',
              event_label: 'FID',
              value: Math.round(entry.processingStart - entry.startTime)
            });
          }
          
          if (entry.entryType === 'layout-shift' && !entry.hadRecentInput) {
            gtag('event', 'web_vital', {
              event_category: 'performance',
              event_label: 'CLS',
              value: entry.value
            });
          }
        });
      });
      
      observer.observe({ entryTypes: ['largest-contentful-paint', 'first-input', 'layout-shift'] });
    }
    
    // Event listeners
    window.addEventListener('scroll', checkArticleCompletion);
    window.pageLoadTime = Date.now();
    
    console.log('âœ… Conversion Tracking: Initialized successfully');
  });
</script>