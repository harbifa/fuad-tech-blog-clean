---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Hero from '../components/Hero.astro';
import CategorySection from '../components/CategorySection.astro';
import BlogCard from '../components/BlogCard.astro';
import Footer from '../components/Footer.astro';

// Get all posts and sort by date
const allPosts = await getCollection('posts');
const sortedPosts = allPosts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Get featured posts
const featuredPosts = sortedPosts
  .filter(post => post.data.featured)
  .slice(0, 3)
  .map(post => ({
    title: post.data.title,
    excerpt: post.data.description,
    category: post.data.category,
    date: post.data.date.toLocaleDateString('ar-SA', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    }),
    readTime: post.data.readTime,
    image: post.data.image,
    slug: post.slug,
    tags: post.data.tags,
    featured: post.data.featured,
    affiliate: post.data.affiliate
  }));

// Get recent posts (excluding featured ones)
const recentPosts = sortedPosts
  .filter(post => !post.data.featured)
  .slice(0, 3)
  .map(post => ({
    title: post.data.title,
    excerpt: post.data.description,
    category: post.data.category,
    date: post.data.date.toLocaleDateString('ar-SA', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    }),
    readTime: post.data.readTime,
    image: post.data.image,
    slug: post.slug,
    tags: post.data.tags,
    featured: post.data.featured,
    affiliate: post.data.affiliate
  }));
---

<Layout title="مدونة عزيز - متخصصة في الشبكات والأمن السيبراني والتسويق الرقمي">
  <Header />
  <Hero />
  <CategorySection />
  
  <!-- Featured Posts -->
  {featuredPosts.length > 0 && (
    <section id="latest-posts" class="py-16">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <h2 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">
            المقالات المميزة
          </h2>
          <p class="text-xl text-gray-600 dark:text-gray-300">
            اكتشف أحدث المقالات والدروس المتخصصة
          </p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
          {featuredPosts.map(post => (
            <BlogCard {...post} />
          ))}
        </div>
      </div>
    </section>
  )}
  
  <!-- Recent Posts -->
  {recentPosts.length > 0 && (
    <section class="py-16 bg-gray-50 dark:bg-gray-800">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <h2 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">
            أحدث المقالات
          </h2>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {recentPosts.map(post => (
            <BlogCard {...post} />
          ))}
        </div>
        
        <div class="text-center mt-12">
          <a 
            href="/posts" 
            class="inline-flex items-center px-8 py-3 bg-primary-600 hover:bg-primary-700 text-white font-semibold rounded-lg transition-colors"
          >
            عرض جميع المقالات
            <i class="fas fa-arrow-left ml-2"></i>
          </a>
        </div>
      </div>
    </section>
  )}
  
  <!-- Newsletter -->
  <section class="py-16">
    <div class="container mx-auto px-4">
      <div class="bg-gradient-to-r from-primary-600 to-secondary-600 rounded-2xl p-8 md:p-12 text-white text-center">
        <h3 class="text-3xl font-bold mb-4">
          اشترك في النشرة البريدية
        </h3>
        <p class="text-xl text-white/90 mb-8 max-w-2xl mx-auto">
          احصل على أحدث المقالات والدروس مباشرة في بريدك الإلكتروني
        </p>
        
        <form class="max-w-md mx-auto flex gap-4" id="newsletter-form-home" action="/api/newsletter" method="POST">
          <input 
            type="email" 
            name="email"
            placeholder="بريدك الإلكتروني"
            class="flex-1 px-4 py-3 rounded-lg border-0 text-gray-900 placeholder-gray-500"
            required
          />
          <input type="text" name="company" class="hidden" tabindex="-1" autocomplete="off" aria-hidden="true" />
          <button 
            type="submit"
            class="px-6 py-3 bg-white text-primary-600 font-semibold rounded-lg hover:bg-gray-100 transition-colors"
          >
            اشتراك
          </button>
        </form>
        <div id="newsletter-message-home" class="mt-4 text-center text-sm" style="display: none;"></div>
      </div>
    </div>
  </section>
  
  <Footer />
</Layout>

<style>
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
  const form = document.getElementById('newsletter-form-home');
  const message = document.getElementById('newsletter-message-home');
  
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const button = form.querySelector('button');
    const originalText = button.innerHTML;
    const formData = new FormData(form);
    
    // Show loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>جاري الاشتراك...';
    button.disabled = true;
    message.style.display = 'none';
    
    try {
      const response = await fetch(form.action, { 
        method: 'POST', 
        body: formData 
      });
      
      const data = await response.json();
      
      // Show message
      message.textContent = data.message || (data.ok ? "تم الاشتراك" : "تعذّر الاشتراك");
      message.style.display = 'block';
      message.className = `mt-4 text-center text-sm ${data.ok ? 'text-green-200' : 'text-red-200'}`;
      
      if (data.ok) {
        // Success state
        button.innerHTML = '<i class="fas fa-check ml-2"></i>تم الإرسال';
        button.classList.remove('bg-white', 'text-primary-600');
        button.classList.add('bg-green-500', 'text-white');
        
        // Analytics
        if (typeof gtag !== 'undefined') {
          gtag('event', 'newsletter_signup', {
            email: formData.get('email'),
            source: 'homepage'
          });
        }
        
        form.reset();
        
        // Reset button after 4 seconds
        setTimeout(() => {
          button.innerHTML = originalText;
          button.disabled = false;
          button.classList.remove('bg-green-500', 'text-white');
          button.classList.add('bg-white', 'text-primary-600');
        }, 4000);
        
      } else {
        // Error state
        button.innerHTML = '<i class="fas fa-exclamation-triangle ml-2"></i>خطأ';
        button.classList.remove('bg-white', 'text-primary-600');
        button.classList.add('bg-red-500', 'text-white');
        
        // Reset button after 4 seconds
        setTimeout(() => {
          button.innerHTML = originalText;
          button.disabled = false;
          button.classList.remove('bg-red-500', 'text-white');
          button.classList.add('bg-white', 'text-primary-600');
        }, 4000);
      }
      
    } catch (error) {
      console.error('Newsletter signup error:', error);
      
      // Error state
      message.textContent = "تعذّر الاشتراك. حاول لاحقًا.";
      message.style.display = 'block';
      message.className = 'mt-4 text-center text-sm text-red-200';
      
      button.innerHTML = '<i class="fas fa-exclamation-triangle ml-2"></i>خطأ في الاتصال';
      button.classList.remove('bg-white', 'text-primary-600');
      button.classList.add('bg-red-500', 'text-white');
      
      // Reset button after 4 seconds
      setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
        button.classList.remove('bg-red-500', 'text-white');
        button.classList.add('bg-white', 'text-primary-600');
      }, 4000);
    }
  });
</script>