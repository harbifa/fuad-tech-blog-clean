---
export interface Props {
  variant?: 'default' | 'compact' | 'sidebar';
  source?: string;
  title?: string;
  description?: string;
}

const { 
  variant = 'default',
  source = 'unknown',
  title = 'ğŸ¯ Ù„Ø§ ØªÙÙˆØª Ø£ÙŠ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø¹Ø§Ù„Ù… Ø§Ù„Ø£Ù…Ø§Ù†',
  description = 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª ÙˆØ§Ù„Ù†ØµØ§Ø¦Ø­ Ø§Ù„Ø£Ù…Ù†ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'
} = Astro.props;

// Generate unique form ID for each instance
const formId = `brevo-newsletter-${source}-${Math.random().toString(36).substr(2, 9)}`;
---

<div class={`brevo-newsletter-wrapper ${variant}`}>
  {variant === 'default' && (
    <div class="newsletter-signup bg-gradient-to-r from-primary-600 to-secondary-600 rounded-2xl p-8 text-white my-12">
      <div class="max-w-2xl mx-auto text-center">
        <div class="w-16 h-16 bg-white/10 rounded-2xl flex items-center justify-center mx-auto mb-6">
          <i class="fas fa-envelope text-2xl"></i>
        </div>
        
        <h3 class="text-2xl font-bold mb-4">
          {title}
        </h3>
        
        <p class="text-white/90 mb-6">
          {description}
          <br>
          <span class="text-sm opacity-75">Ù†Ø±Ø³Ù„ Ù…Ø­ØªÙˆÙ‰ Ø­ØµØ±ÙŠ Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹</span>
        </p>
        
        <!-- Brevo Form -->
        <div id={formId} class="brevo-form-container">
          <form 
            class="flex flex-col sm:flex-row gap-4 max-w-md mx-auto brevo-newsletter-form" 
            action="https://f6e62a1c.sibforms.com/serve/MUIFABVvGn-CgKbLBT8_4_example" 
            method="POST"
            target="_blank"
            rel="noopener noreferrer"
          >
            <!-- Brevo Required Fields -->
            <input type="text" name="email_address_check" class="hidden" tabindex="-1" autocomplete="off" aria-hidden="true" />
            <input type="hidden" name="locale" value="ar" />
            <input type="hidden" name="html_type" value="simple" />
            
            <!-- Custom Fields for Tracking -->
            <input type="hidden" name="source" value={source} />
            <input type="hidden" name="language" value="arabic" />
            <input type="hidden" name="website" value="fuad3ziz.com" />
            
            <input 
              type="email" 
              name="EMAIL"
              placeholder="Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"
              class="flex-1 px-4 py-3 rounded-lg border-0 text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-white/50"
              required
              autocomplete="email"
            />
            
            <button 
              type="submit"
              class="px-6 py-3 bg-white text-primary-600 font-semibold rounded-lg hover:bg-gray-100 transition-colors shadow-md hover:shadow-lg brevo-submit-btn"
            >
              Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ø¬Ø§Ù†ÙŠ
            </button>
          </form>
          
          <div class="brevo-message mt-4 text-center text-sm" style="display: none;"></div>
        </div>
        
        <div class="flex items-center justify-center mt-4 text-sm text-white/70">
          <i class="fas fa-shield-alt ml-2"></i>
          Ù†Ø­ØªØ±Ù… Ø®ØµÙˆØµÙŠØªÙƒ - Ù„Ø§ Ø³Ø¨Ø§Ù… Ø£Ø¨Ø¯Ø§Ù‹
        </div>
      </div>
    </div>
  )}

  {variant === 'compact' && (
    <div class="bg-gradient-to-r from-primary-600 to-secondary-600 rounded-2xl p-8 md:p-12 text-white text-center">
      <div class="max-w-3xl mx-auto">
        <div class="w-16 h-16 bg-white/10 rounded-2xl flex items-center justify-center mx-auto mb-6">
          <i class="fas fa-envelope text-2xl"></i>
        </div>
        <h3 class="text-3xl font-bold mb-4">
          {title}
        </h3>
        <p class="text-xl text-white/90 mb-8">
          {description}
        </p>
        
        <!-- Brevo Form Compact -->
        <div id={formId} class="brevo-form-container">
          <form 
            class="max-w-md mx-auto flex gap-4 brevo-newsletter-form" 
            action="https://f6e62a1c.sibforms.com/serve/MUIFABVvGn-CgKbLBT8_4_example" 
            method="POST"
            target="_blank"
            rel="noopener noreferrer"
          >
            <!-- Brevo Required Fields -->
            <input type="text" name="email_address_check" class="hidden" tabindex="-1" autocomplete="off" aria-hidden="true" />
            <input type="hidden" name="locale" value="ar" />
            <input type="hidden" name="html_type" value="simple" />
            <input type="hidden" name="source" value={source} />
            
            <input 
              type="email" 
              name="EMAIL"
              placeholder="Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"
              class="flex-1 px-4 py-3 rounded-lg border-0 text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-white/50"
              required
              autocomplete="email"
            />
            <button 
              type="submit"
              class="px-6 py-3 bg-white text-primary-600 font-semibold rounded-lg hover:bg-gray-100 transition-colors shadow-md hover:shadow-lg brevo-submit-btn"
            >
              Ø§Ø´ØªØ±Ø§Ùƒ
            </button>
          </form>
          <div class="brevo-message mt-4 text-center text-sm" style="display: none;"></div>
        </div>
        
        <p class="text-sm text-white/70 mt-4">
          <i class="fas fa-shield-alt ml-2"></i>
          Ù†Ø­ØªØ±Ù… Ø®ØµÙˆØµÙŠØªÙƒ ÙˆÙ„Ù† Ù†Ø±Ø³Ù„ Ù„Ùƒ Ø³Ø¨Ø§Ù…
        </p>
      </div>
    </div>
  )}

  {variant === 'sidebar' && (
    <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-6 my-8">
      <div class="text-center">
        <div class="w-12 h-12 bg-primary-100 dark:bg-primary-900 rounded-xl flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-envelope text-primary-600 dark:text-primary-400"></i>
        </div>
        
        <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-2">
          Ø§Ù„Ù†Ø´Ø±Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠØ©
        </h4>
        
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
          {description}
        </p>
        
        <!-- Brevo Form Sidebar -->
        <div id={formId} class="brevo-form-container">
          <form 
            class="space-y-3 brevo-newsletter-form" 
            action="https://f6e62a1c.sibforms.com/serve/MUIFABVvGn-CgKbLBT8_4_example" 
            method="POST"
            target="_blank"
            rel="noopener noreferrer"
          >
            <!-- Brevo Required Fields -->
            <input type="text" name="email_address_check" class="hidden" tabindex="-1" autocomplete="off" aria-hidden="true" />
            <input type="hidden" name="locale" value="ar" />
            <input type="hidden" name="html_type" value="simple" />
            <input type="hidden" name="source" value={source} />
            
            <input 
              type="email" 
              name="EMAIL"
              placeholder="Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"
              class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-primary-500"
              required
              autocomplete="email"
            />
            
            <button 
              type="submit"
              class="w-full px-4 py-2 bg-primary-600 text-white font-semibold rounded-lg hover:bg-primary-700 transition-colors brevo-submit-btn"
            >
              Ø§Ø´ØªØ±Ø§Ùƒ
            </button>
          </form>
          <div class="brevo-message mt-3 text-center text-sm" style="display: none;"></div>
        </div>
      </div>
    </div>
  )}
</div>

<script>
  // Enhanced Brevo Form Handler
  document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('.brevo-newsletter-form');
    
    forms.forEach(form => {
      const container = form.closest('.brevo-form-container');
      const message = container?.querySelector('.brevo-message');
      const button = form.querySelector('.brevo-submit-btn');
      
      if (!form || !button) return;
      
      const originalButtonText = button.innerHTML;
      
      form.addEventListener('submit', function(e) {
        // Don't prevent default - let Brevo handle the submission
        
        // Show loading state
        button.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ...';
        button.disabled = true;
        
        // Hide any previous messages
        if (message) {
          message.style.display = 'none';
        }
        
        // Track the submission in Analytics
        const email = form.querySelector('input[name="EMAIL"]')?.value;
        const source = form.querySelector('input[name="source"]')?.value || 'unknown';
        
        if (typeof gtag !== 'undefined' && email) {
          gtag('event', 'newsletter_signup_attempt', {
            email: email,
            source: source,
            method: 'brevo_form'
          });
        }
        
        // Since we're using target="_blank", we need to handle the UI differently
        // Show success message after a short delay
        setTimeout(() => {
          if (message) {
            message.innerHTML = '<span class="text-green-600 dark:text-green-400"><i class="fas fa-check ml-2"></i>ØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ! Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.</span>';
            message.style.display = 'block';
          }
          
          // Reset button state
          button.innerHTML = '<i class="fas fa-check ml-2"></i>ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
          button.classList.add('bg-green-500', 'hover:bg-green-600');
          
          // Track successful form opening
          if (typeof gtag !== 'undefined') {
            gtag('event', 'newsletter_form_opened', {
              source: source,
              method: 'brevo_form'
            });
          }
          
          // Reset after 5 seconds
          setTimeout(() => {
            button.innerHTML = originalButtonText;
            button.disabled = false;
            button.classList.remove('bg-green-500', 'hover:bg-green-600');
            
            if (message) {
              message.style.display = 'none';
            }
          }, 5000);
          
        }, 1000);
      });
    });
  });
</script>

<style>
  .brevo-newsletter-wrapper {
    position: relative;
  }
  
  .brevo-form-container {
    position: relative;
  }
  
  .brevo-newsletter-form input[type="email"] {
    transition: all 0.3s ease;
  }
  
  .brevo-newsletter-form input[type="email"]:focus {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  
  .brevo-submit-btn {
    transition: all 0.3s ease;
  }
  
  .brevo-submit-btn:hover {
    transform: translateY(-1px);
  }
  
  .brevo-submit-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }
  
  .brevo-message {
    animation: fadeIn 0.3s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
