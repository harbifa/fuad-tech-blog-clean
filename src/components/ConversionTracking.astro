---
// تتبع التحويلات والأهداف
---

<script>
  // نظام تتبع التحويلات
  document.addEventListener('DOMContentLoaded', function() {
    console.log('🎯 Conversion Tracking: Initializing...');
    
    // تعريف الأهداف
    const conversionGoals = {
      newsletter_signup: {
        name: 'اشتراك النشرة البريدية',
        value: 5,
        currency: 'SAR'
      },
      affiliate_click: {
        name: 'نقرة رابط تابع',
        value: 2,
        currency: 'SAR'
      },
      article_complete: {
        name: 'إكمال قراءة مقال',
        value: 1,
        currency: 'SAR'
      },
      search_performed: {
        name: 'بحث في الموقع',
        value: 0.5,
        currency: 'SAR'
      },
      social_share: {
        name: 'مشاركة اجتماعية',
        value: 1.5,
        currency: 'SAR'
      },
      pwa_install: {
        name: 'تثبيت التطبيق',
        value: 10,
        currency: 'SAR'
      }
    };
    
    // تتبع التحويل
    function trackConversion(goalType, additionalData = {}) {
      const goal = conversionGoals[goalType];
      if (!goal) return;
      
      gtag('event', 'conversion', {
        send_to: 'AW-CONVERSION_ID/CONVERSION_LABEL', // استبدل بمعرف التحويل الفعلي
        value: goal.value,
        currency: goal.currency,
        event_category: 'conversion',
        event_label: goal.name,
        ...additionalData
      });
      
      // تتبع مخصص للتحويل
      gtag('event', goalType, {
        event_category: 'goal_completion',
        event_label: goal.name,
        value: goal.value,
        ...additionalData
      });
      
      console.log('🎯 Conversion tracked:', goalType, goal);
    }
    
    // تتبع اشتراك النشرة البريدية
    const newsletterForms = document.querySelectorAll('#newsletter-form, [data-newsletter-form]');
    newsletterForms.forEach(form => {
      form.addEventListener('submit', function(e) {
        trackConversion('newsletter_signup', {
          form_location: this.dataset.location || 'unknown'
        });
      });
    });
    
    // تتبع النقرات على الروابط التابعة
    document.addEventListener('click', function(e) {
      const link = e.target.closest('a');
      if (!link) return;
      
      // روابط تابعة
      if (link.classList.contains('affiliate-link') || 
          link.href.includes('amazon.com') || 
          link.href.includes('affiliate') ||
          link.closest('[data-affiliate]')) {
        
        const productName = link.textContent.trim() || 
                           link.closest('[data-product-name]')?.dataset.productName || 
                           'unknown_product';
        
        trackConversion('affiliate_click', {
          product_name: productName,
          link_url: link.href,
          link_position: getElementPosition(link)
        });
      }
      
      // مشاركة اجتماعية
      if (link.href.includes('twitter.com/intent') || 
          link.href.includes('linkedin.com/sharing') || 
          link.href.includes('wa.me')) {
        
        const platform = link.href.includes('twitter') ? 'twitter' :
                        link.href.includes('linkedin') ? 'linkedin' :
                        link.href.includes('wa.me') ? 'whatsapp' : 'other';
        
        trackConversion('social_share', {
          platform: platform,
          content_type: 'article',
          content_id: window.location.pathname
        });
      }
    });
    
    // تتبع إكمال قراءة المقال
    let articleCompleted = false;
    function checkArticleCompletion() {
      if (articleCompleted) return;
      
      const article = document.querySelector('article');
      if (!article) return;
      
      const scrollTop = window.pageYOffset;
      const articleTop = article.offsetTop;
      const articleHeight = article.offsetHeight;
      const windowHeight = window.innerHeight;
      
      const scrolledPastArticle = scrollTop + windowHeight >= articleTop + articleHeight * 0.9;
      const timeOnPage = (Date.now() - window.pageLoadTime) / 1000;
      
      if (scrolledPastArticle && timeOnPage >= 60) {
        articleCompleted = true;
        trackConversion('article_complete', {
          article_title: document.title,
          reading_time: Math.round(timeOnPage),
          article_category: document.querySelector('[data-category]')?.dataset.category || 'unknown'
        });
      }
    }
    
    // تتبع البحث
    const searchInputs = document.querySelectorAll('#search-input, [type="search"]');
    searchInputs.forEach(input => {
      let searchTimeout;
      input.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          if (this.value.length >= 3) {
            trackConversion('search_performed', {
              search_term: this.value,
              search_location: this.closest('[data-search-location]')?.dataset.searchLocation || 'header'
            });
          }
        }, 1000);
      });
    });
    
    // تتبع تثبيت PWA
    window.addEventListener('beforeinstallprompt', function() {
      // سيتم تتبعه عند النقر على زر التثبيت
      const installButtons = document.querySelectorAll('#pwa-install-btn, [data-pwa-install]');
      installButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          trackConversion('pwa_install', {
            install_method: 'prompt',
            user_agent: navigator.userAgent
          });
        });
      });
    });
    
    // تتبع التفاعل مع المحتوى المميز
    const featuredContent = document.querySelectorAll('[data-featured], .featured');
    featuredContent.forEach(element => {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            gtag('event', 'view_promotion', {
              promotion_id: element.dataset.promotionId || 'featured_content',
              promotion_name: element.dataset.promotionName || 'Featured Content',
              creative_name: element.dataset.creativeName || 'Default',
              creative_slot: getElementPosition(element)
            });
          }
        });
      }, { threshold: 0.5 });
      
      observer.observe(element);
    });
    
    // دالة مساعدة لتحديد موقع العنصر
    function getElementPosition(element) {
      const rect = element.getBoundingClientRect();
      const scrollTop = window.pageYOffset;
      const elementTop = rect.top + scrollTop;
      
      if (elementTop < window.innerHeight) return 'above_fold';
      if (elementTop < window.innerHeight * 2) return 'below_fold';
      return 'deep_scroll';
    }
    
    // تتبع الأداء المتقدم
    if ('PerformanceObserver' in window) {
      // تتبع Core Web Vitals
      const observer = new PerformanceObserver((list) => {
        list.getEntries().forEach((entry) => {
          if (entry.entryType === 'largest-contentful-paint') {
            gtag('event', 'web_vital', {
              event_category: 'performance',
              event_label: 'LCP',
              value: Math.round(entry.startTime)
            });
          }
          
          if (entry.entryType === 'first-input') {
            gtag('event', 'web_vital', {
              event_category: 'performance',
              event_label: 'FID',
              value: Math.round(entry.processingStart - entry.startTime)
            });
          }
          
          if (entry.entryType === 'layout-shift' && !entry.hadRecentInput) {
            gtag('event', 'web_vital', {
              event_category: 'performance',
              event_label: 'CLS',
              value: entry.value
            });
          }
        });
      });
      
      observer.observe({ entryTypes: ['largest-contentful-paint', 'first-input', 'layout-shift'] });
    }
    
    // Event listeners
    window.addEventListener('scroll', checkArticleCompletion);
    window.pageLoadTime = Date.now();
    
    console.log('✅ Conversion Tracking: Initialized successfully');
  });
</script>